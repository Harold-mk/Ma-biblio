<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'Emprunt #' + ${emprunt.id} + ' - Biblio-Tech'">Détail de l'Emprunt - Biblio-Tech</title>
    
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <link th:href="@{/css/admin.css}" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <div th:replace="~{fragments/header :: header}"></div>
    
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div th:replace="~{fragments/sidebar-admin :: sidebar-admin}"></div>
            
            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Détail de l'Emprunt</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <a th:href="@{/admin/emprunts/{id}/edit(id=${emprunt.id})}" class="btn btn-warning">
                                <i class="fas fa-edit me-1"></i>Modifier
                            </a>
                            <a href="/admin/emprunts" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Retour à la liste
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Flash Messages -->
                <div th:replace="~{fragments/alerts :: alerts}"></div>
                
                <!-- Loan Details -->
                <div class="row">
                    <!-- Left Column - Loan Information -->
                    <div class="col-lg-8">
                        <!-- Basic Information -->
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">
                                    <i class="fas fa-info-circle me-2"></i>Informations Générales
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <dl class="row">
                                            <dt class="col-sm-4">ID Emprunt :</dt>
                                            <dd class="col-sm-8" th:text="${emprunt.id}">ID</dd>
                                            
                                            <dt class="col-sm-4">État :</dt>
                                            <dd class="col-sm-8">
                                                <span th:class="${emprunt.etatEmprunt == T(com.haroldmokam.ma_biblio.entites.EtatEmprunt).EN_COURS ? 'badge bg-success' : 
                                                               emprunt.etatEmprunt == T(com.haroldmokam.ma_biblio.entites.EtatEmprunt).DELAI_EXPIRE ? 'badge bg-danger' : 
                                                               'badge bg-secondary'}" 
                                                      th:text="${emprunt.etatEmprunt}">État</span>
                                            </dd>
                                            
                                            <dt class="col-sm-4">Date d'emprunt :</dt>
                                            <dd class="col-sm-8" th:text="${#temporals.format(emprunt.dateDebutEmprunt, 'dd/MM/yyyy')}">Date début</dd>
                                        </dl>
                                    </div>
                                    <div class="col-md-6">
                                        <dl class="row">
                                            <dt class="col-sm-4">Date de retour :</dt>
                                            <dd class="col-sm-8">
                                                <span th:text="${#temporals.format(emprunt.dateFinEmprunt, 'dd/MM/yyyy')}" 
                                                      th:class="${emprunt.dateFinEmprunt.isBefore(T(java.time.LocalDate).now()) ? 'text-danger fw-bold' : ''}">Date fin</span>
                                            </dd>
                                            
                                            <dt class="col-sm-4">Durée :</dt>
                                            <dd class="col-sm-8" th:text="${#temporals.between(emprunt.dateDebutEmprunt, emprunt.dateFinEmprunt).days} + ' jours'">Durée</dd>
                                            
                                            <dt class="col-sm-4">Jours restants :</dt>
                                            <dd class="col-sm-8">
                                                <span th:if="${emprunt.etatEmprunt == T(com.haroldmokam.ma_biblio.entites.EtatEmprunt).EN_COURS || emprunt.etatEmprunt == T(com.haroldmokam.ma_biblio.entites.EtatEmprunt).DELAI_EXPIRE}"
                                                      th:text="${#temporals.between(T(java.time.LocalDate).now(), emprunt.dateFinEmprunt).days}"
                                                      th:class="${#temporals.between(T(java.time.LocalDate).now(), emprunt.dateFinEmprunt).days < 0 ? 'text-danger fw-bold' : 
                                                                 #temporals.between(T(java.time.LocalDate).now(), emprunt.dateFinEmprunt).days <= 3 ? 'text-warning fw-bold' : ''}">
                                                    Jours restants
                                                </span>
                                                <span th:unless="${emprunt.etatEmprunt == T(com.haroldmokam.ma_biblio.entites.EtatEmprunt).EN_COURS || emprunt.etatEmprunt == T(com.haroldmokam.ma_biblio.entites.EtatEmprunt).DELAI_EXPIRE}"
                                                      class="text-muted">Terminé</span>
                                            </dd>
                                        </dl>
                                    </div>
                                </div>
                                
                                <!-- Comment -->
                                <div class="mt-3" th:if="${emprunt.commentaire}">
                                    <h6>Commentaire :</h6>
                                    <p class="text-muted" th:text="${emprunt.commentaire}">Commentaire de l'emprunt</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Book Information -->
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">
                                    <i class="fas fa-book me-2"></i>Informations du Livre
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 text-center">
                                        <img th:if="${emprunt.livre.imageUrl}" th:src="${emprunt.livre.imageUrl}" 
                                             class="img-fluid rounded" style="max-height: 150px;"
                                             alt="Couverture du livre">
                                        <div th:unless="${emprunt.livre.imageUrl}" class="bg-light d-flex align-items-center justify-content-center rounded" 
                                             style="height: 150px;">
                                            <i class="fas fa-book fa-3x text-muted"></i>
                                        </div>
                                    </div>
                                    <div class="col-md-9">
                                        <h5 th:text="${emprunt.livre.titre}">Titre du livre</h5>
                                        <p class="text-muted" th:text="${emprunt.livre.auteur}">Auteur</p>
                                        <p th:text="${emprunt.livre.description}">Description du livre</p>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <small class="text-muted">Catégorie :</small><br>
                                                <span class="badge bg-info" th:text="${emprunt.livre.categorie.libelle}">Catégorie</span>
                                            </div>
                                            <div class="col-md-4">
                                                <small class="text-muted">Exemplaires :</small><br>
                                                <span class="badge bg-secondary" th:text="${emprunt.livre.nbreExemplairesInitial}">Total</span>
                                                /
                                                <span th:class="${emprunt.livre.nbreExemplairesRestant > 0 ? 'badge bg-success' : 'badge bg-danger'}" 
                                                      th:text="${emprunt.livre.nbreExemplairesRestant}">Disponibles</span>
                                            </div>
                                            <div class="col-md-4">
                                                <small class="text-muted">ID Livre :</small><br>
                                                <span th:text="${emprunt.livre.id}">ID</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- User Information -->
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">
                                    <i class="fas fa-user me-2"></i>Informations de l'Utilisateur
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 text-center">
                                        <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center" 
                                             style="width: 100px; height: 100px;">
                                            <i class="fas fa-user fa-2x"></i>
                                        </div>
                                    </div>
                                    <div class="col-md-9">
                                        <h5 th:text="${emprunt.utilisateur.nom + ' ' + emprunt.utilisateur.prenom}">Nom complet</h5>
                                        <p class="text-muted" th:text="${emprunt.utilisateur.mail}">email@exemple.com</p>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <small class="text-muted">Matricule :</small><br>
                                                <strong th:text="${emprunt.utilisateur.matricule}">MAT001</strong>
                                            </div>
                                            <div class="col-md-4">
                                                <small class="text-muted">Rôle :</small><br>
                                                <span th:class="${emprunt.utilisateur.role == T(com.haroldmokam.ma_biblio.entites.RoleUtilisateur).BIBLIOTHÉCAIRE ? 'badge bg-primary' : 'badge bg-info'}" 
                                                      th:text="${emprunt.utilisateur.role}">Rôle</span>
                                            </div>
                                            <div class="col-md-4">
                                                <small class="text-muted">Statut :</small><br>
                                                <span th:class="${emprunt.utilisateur.statut == T(com.haroldmokam.ma_biblio.entites.Statut).ACTIF ? 'badge bg-success' : 'badge bg-danger'}" 
                                                      th:text="${emprunt.utilisateur.statut}">Statut</span>
                                            </div>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-md-6">
                                                <small class="text-muted">Emprunts actifs :</small><br>
                                                <span class="badge bg-warning" th:text="${emprunt.utilisateur.nombreEmpruntActif}">0</span>
                                            </div>
                                            <div class="col-md-6">
                                                <small class="text-muted">Emprunts restants :</small><br>
                                                <span class="badge bg-success" th:text="${emprunt.utilisateur.nombreEmpruntRestant}">5</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column - Actions and Status -->
                    <div class="col-lg-4">
                        <!-- Status Card -->
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">
                                    <i class="fas fa-chart-pie me-2"></i>Statut de l'Emprunt
                                </h6>
                            </div>
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i th:class="${emprunt.etatEmprunt == T(com.haroldmokam.ma_biblio.entites.EtatEmprunt).EN_COURS ? 'fas fa-check-circle fa-3x text-success' : 
                                                 emprunt.etatEmprunt == T(com.haroldmokam.ma_biblio.entites.EtatEmprunt).DELAI_EXPIRE ? 'fas fa-exclamation-triangle fa-3x text-danger' : 
                                                 'fas fa-times-circle fa-3x text-secondary'}"></i>
                                </div>
                                
                                <h5 th:text="${emprunt.etatEmprunt}">État</h5>
                                
                                <div class="mt-3">
                                    <span th:if="${emprunt.etatEmprunt == T(com.haroldmokam.ma_biblio.entites.EtatEmprunt).EN_COURS}" class="badge bg-success fs-6">
                                        En cours
                                    </span>
                                    <span th:if="${emprunt.etatEmprunt == T(com.haroldmokam.ma_biblio.entites.EtatEmprunt).DELAI_EXPIRE}" class="badge bg-danger fs-6">
                                        En retard
                                    </span>
                                    <span th:if="${emprunt.etatEmprunt == T(com.haroldmokam.ma_biblio.entites.EtatEmprunt).REMIS}" class="badge bg-secondary fs-6">
                                        Retourné
                                    </span>
                                </div>
                                
                                <!-- Days remaining or overdue -->
                                <div class="mt-3" th:if="${emprunt.etatEmprunt == T(com.haroldmokam.ma_biblio.entites.EtatEmprunt).EN_COURS || emprunt.etatEmprunt == T(com.haroldmokam.ma_biblio.entites.EtatEmprunt).DELAI_EXPIRE}">
                                    <div th:if="${#temporals.between(T(java.time.LocalDate).now(), emprunt.dateFinEmprunt).days >= 0}">
                                        <h6 class="text-success">
                                            <i class="fas fa-clock me-1"></i>
                                            <span th:text="${#temporals.between(T(java.time.LocalDate).now(), emprunt.dateFinEmprunt).days} + ' jours restants'">Jours restants</span>
                                        </h6>
                                    </div>
                                    <div th:if="${#temporals.between(T(java.time.LocalDate).now(), emprunt.dateFinEmprunt).days < 0}">
                                        <h6 class="text-danger">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            <span th:text="${#temporals.between(T(java.time.LocalDate).now(), emprunt.dateFinEmprunt).days * -1} + ' jours de retard'">Jours de retard</span>
                                        </h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Actions Card -->
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">
                                    <i class="fas fa-tools me-2"></i>Actions
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <a th:href="@{/admin/emprunts/{id}/edit(id=${emprunt.id})}" class="btn btn-warning">
                                        <i class="fas fa-edit me-2"></i>Modifier l'emprunt
                                    </a>
                                    
                                    <button type="button" class="btn btn-success" 
                                            th:if="${emprunt.etatEmprunt == T(com.haroldmokam.ma_biblio.entites.EtatEmprunt).EN_COURS || emprunt.etatEmprunt == T(com.haroldmokam.ma_biblio.entites.EtatEmprunt).DELAI_EXPIRE}"
                                            onclick="retournerLivre()">
                                        <i class="fas fa-undo me-2"></i>Retourner le livre
                                    </button>
                                    
                                    <button type="button" class="btn btn-info" 
                                            th:if="${emprunt.etatEmprunt == T(com.haroldmokam.ma_biblio.entites.EtatEmprunt).EN_COURS || emprunt.etatEmprunt == T(com.haroldmokam.ma_biblio.entites.EtatEmprunt).DELAI_EXPIRE}"
                                            onclick="prolongerEmprunt()">
                                        <i class="fas fa-clock me-2"></i>Prolonger l'emprunt
                                    </button>
                                    
                                    <a th:href="@{/admin/utilisateurs/{id}(id=${emprunt.utilisateur.id})}" class="btn btn-outline-primary">
                                        <i class="fas fa-user me-2"></i>Voir l'utilisateur
                                    </a>
                                    
                                    <a th:href="@{/admin/livres/{id}(id=${emprunt.livre.id})}" class="btn btn-outline-success">
                                        <i class="fas fa-book me-2"></i>Voir le livre
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Timeline Card -->
                        <div class="card shadow">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">
                                    <i class="fas fa-history me-2"></i>Historique
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="timeline">
                                    <div class="timeline-item">
                                        <div class="timeline-marker bg-primary"></div>
                                        <div class="timeline-content">
                                            <h6 class="mb-1">Emprunt créé</h6>
                                            <p class="text-muted mb-0" th:text="${#temporals.format(emprunt.dateDebutEmprunt, 'dd/MM/yyyy')}">Date</p>
                                        </div>
                                    </div>
                                    <div class="timeline-item" th:if="${emprunt.etatEmprunt == T(com.haroldmokam.ma_biblio.entites.EtatEmprunt).DELAI_EXPIRE}">
                                        <div class="timeline-marker bg-danger"></div>
                                        <div class="timeline-content">
                                            <h6 class="mb-1">Date limite dépassée</h6>
                                            <p class="text-muted mb-0" th:text="${#temporals.format(emprunt.dateFinEmprunt, 'dd/MM/yyyy')}">Date</p>
                                        </div>
                                    </div>
                                    <div class="timeline-item" th:if="${emprunt.etatEmprunt == T(com.haroldmokam.ma_biblio.entites.EtatEmprunt).REMIS}">
                                        <div class="timeline-marker bg-success"></div>
                                        <div class="timeline-content">
                                            <h6 class="mb-1">Livre retourné</h6>
                                            <p class="text-muted mb-0">Date de retour</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Bootstrap 5.3 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script th:src="@{/js/app.js}"></script>
    <script th:src="@{/js/admin.js}"></script>
    
    <script>
        function retournerLivre() {
            if (confirm('Êtes-vous sûr de vouloir retourner ce livre ?')) {
                window.location.href = `/admin/emprunts/${empruntId}/retourner`;
            }
        }
        
        function prolongerEmprunt() {
            if (confirm('Êtes-vous sûr de vouloir prolonger cet emprunt de 2 semaines ?')) {
                window.location.href = `/admin/emprunts/${empruntId}/prolonger`;
            }
        }
        
        // Get emprunt ID from the page
        const empruntId = [[${emprunt.id}]];
    </script>
    
    <style>
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        
        .timeline-marker {
            position: absolute;
            left: -35px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .timeline-content {
            padding-left: 10px;
        }
        
        .timeline-item:not(:last-child)::before {
            content: '';
            position: absolute;
            left: -29px;
            top: 17px;
            width: 2px;
            height: calc(100% + 3px);
            background-color: #e9ecef;
        }
    </style>
</body>
</html>
